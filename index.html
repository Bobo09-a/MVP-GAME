<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Urban Ops â€” FIX v4.3 (PC boutons + Mobile)</title>
<style>
  :root{ --bg:#0b0d13; --ui:#141b24; --ui2:#1c2534; --bd:#2d3a53; --txt:#e7ecff; --muted:#a9b3c9; --accent:#58a6ff; --danger:#ff5858; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Arial}
  canvas{display:block;position:absolute;inset:0}
  #game{position:fixed;inset:0;overflow:hidden}
  /* HUD */
  .hud{position:absolute;left:12px;top:12px;display:flex;gap:8px;align-items:center;z-index:10}
  .pill{background:rgba(20,27,36,.85);border:1px solid var(--bd);border-radius:999px;padding:8px 12px;font-weight:700}
  .btn{background:var(--ui2);border:1px solid var(--bd);border-radius:10px;padding:8px 12px;cursor:pointer;user-select:none}
  .btn:active{transform:scale(.98)}
  .bar{height:10px;background:#111;border-radius:999px;overflow:hidden;border:1px solid #0006}
  .hp{width:160px}
  .hp>i{display:block;height:100%;background:linear-gradient(90deg,#35d07f,#18a364)}
  /* Minimap */
  #mapWrap{position:absolute;right:12px;top:12px;background:rgba(20,27,36,.85);border:1px solid var(--bd);border-radius:10px;padding:6px 6px 2px;z-index:10}
  #map{display:block;width:160px;height:160px;background:#0e1320;border-radius:6px}
  .legend{display:flex;gap:8px;justify-content:space-between;font-size:12px;color:#a9b3c9;margin-top:4px}
  /* Settings panel (petit) */
  #panel{position:absolute;right:12px;top:12px;background:rgba(20,27,36,.95);border:1px solid var(--bd);border-radius:12px;padding:12px;z-index:20;max-width:min(96vw,380px);display:none}
  #panel .row{display:flex;gap:10px;align-items:center;margin:6px 0}
  input[type=range]{width:200px}
  /* On-screen controls (PC + Mobile) */
  .hud-ctrl{position:absolute;inset:0;pointer-events:none;z-index:9}
  #dpad{position:absolute;left:18px;bottom:18px;pointer-events:auto;display:grid;grid-template-columns:74px 74px 74px;grid-template-rows:74px 74px;gap:6px}
  .d{width:74px;height:74px;border-radius:12px;background:rgba(32,41,56,.6);border:1px solid var(--bd);display:grid;place-items:center;font-weight:900;user-select:none}
  .d[data-k="up"]{grid-column:2;grid-row:1}
  .d[data-k="left"]{grid-column:1;grid-row:2}
  .d[data-k="down"]{grid-column:2;grid-row:2}
  .d[data-k="right"]{grid-column:3;grid-row:2}
  #lookPad{position:absolute;right:18px;bottom:18px;width:180px;height:180px;border-radius:50%;background:rgba(32,41,56,.35);border:1px solid var(--bd);pointer-events:auto;touch-action:none}
  #lookKnob{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:68px;height:68px;border-radius:50%;background:rgba(88,166,255,.85);border:2px solid rgba(255,255,255,.45)}
  .action{position:absolute;right:16px;bottom:210px;display:flex;gap:10px;pointer-events:auto}
  .action2{position:absolute;right:16px;bottom:290px;display:flex;gap:10px;pointer-events:auto}
  .action .btn,.action2 .btn{font-weight:900}
  #btnFire{background:rgba(255,88,88,.9);border-color:#ff9c9c}
  /* Crosshair & status */
  #xh{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;z-index:8;pointer-events:none}
  #xh:before,#xh:after{content:"";position:absolute;background:#fff}
  #xh:before{left:7px;top:0;width:2px;height:16px;opacity:.7}
  #xh:after{top:7px;left:0;width:16px;height:2px;opacity:.7}
  #status{position:absolute;left:12px;bottom:12px;background:rgba(20,27,36,.75);border:1px solid var(--bd);padding:6px 8px;border-radius:8px;font-size:12px;z-index:12}
  #hit{position:absolute;inset:0;background:rgba(255,0,0,.14);display:none;z-index:25}
  #over{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:40}
  #overCard{background:rgba(20,27,36,.95);border:1px solid var(--bd);border-radius:12px;padding:16px;width:min(520px,92vw)}
  @media (max-width:980px){ .pill{padding:6px 10px} }
</style>
</head>
<body>
<div id="game"></div>

<!-- HUD -->
<div class="hud">
  <div class="pill">Points: <b id="points">0</b></div>
  <div class="pill">Mission: <span id="mission">â€”</span></div>
  <div class="pill" style="display:flex;gap:8px;align-items:center">
    <span>HP</span><div class="bar hp"><i id="hp" style="width:100%"></i></div>
  </div>
  <div class="btn" id="btnSettings">RÃ©glages</div>
</div>

<div id="mapWrap">
  <canvas id="map" width="160" height="160"></canvas>
  <div class="legend"><span>ðŸŸ¦ Moi</span><span>ðŸ”´ Ennemi</span><span>ðŸŸ¡ Mission</span><span>ðŸŸ  PNJ</span></div>
</div>

<!-- RÃ©glages -->
<div id="panel">
  <div style="font-weight:800;margin-bottom:6px">RÃ©glages rapides</div>
  <div class="row"><span>SensibilitÃ© camÃ©ra</span><input type="range" min="0.3" max="3" step="0.1" id="sens"><span id="sensVal" class="pill">1.0</span></div>
  <div class="row"><label><input type="checkbox" id="invY"> Inverser axe Y</label></div>
  <div class="row"><label><input type="checkbox" id="miniOn" checked> Mini-map</label></div>
  <div class="row"><label><input type="checkbox" id="enemyDmg" checked> DÃ©gÃ¢ts ennemis ON</label></div>
  <div class="row"><div class="btn" id="closePanel">Fermer</div></div>
</div>

<!-- ContrÃ´les Ã  lâ€™Ã©cran (PC + Mobile) -->
<div class="hud-ctrl" id="hudCtrl">
  <div id="dpad">
    <div class="d" data-k="up">â–²</div>
    <div class="d" data-k="left">â—€</div>
    <div class="d" data-k="down">â–¼</div>
    <div class="d" data-k="right">â–¶</div>
  </div>
  <div id="lookPad"><div id="lookKnob"></div></div>
  <div class="action2"><div class="btn" id="btnSprint">SPRINT</div></div>
  <div class="action">
    <div class="btn" id="btnInteract">INTERAGIR</div>
    <div class="btn" id="btnJump">SAUT</div>
    <div class="btn" id="btnFire">FEU</div>
  </div>
</div>

<div id="xh"></div>
<div id="hit"></div>
<div id="status">Statut: initâ€¦</div>

<!-- Game Over -->
<div id="over">
  <div id="overCard">
    <h2 style="margin:0 0 6px">Game Over</h2>
    <div id="overWhy" style="opacity:.8;margin-bottom:10px">HP Ã©puisÃ©s</div>
    <div class="btn" id="btnRetry">Rejouer</div>
  </div>
</div>

<!-- Three.js (non-module, super compatible) -->
<script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
<script>
(function(){
const statusEl=document.getElementById('status');
function status(t){ statusEl.textContent='Statut: '+t; }

// ====== SAVE
const save = JSON.parse(localStorage.getItem('uo_fix_v43')||'{}');
if(!save.init){ Object.assign(save,{init:true,points:1000,sens:1.2,invY:false,mini:true,enemyDmg:true}); }
const store=()=>localStorage.setItem('uo_fix_v43',JSON.stringify(save));

// ====== DOM
const $=id=>document.getElementById(id);
const pointsEl=$('points'), hpBar=$('hp'), missionEl=$('mission');
$('sens').value=save.sens; $('sensVal').textContent=save.sens.toFixed(1);
$('invY').checked=!!save.invY; $('miniOn').checked=save.mini!==false; $('enemyDmg').checked=!!save.enemyDmg;

// ====== STATE
const state={
  running:false, sens:save.sens, invY:!!save.invY, mini:save.mini!==false, enemyDmg:!!save.enemyDmg,
  points:save.points, hp:100, timeAcc:0,
  mv:{up:0,down:0,left:0,right:0}, look:{x:0,y:0}, jump:false, sprint:false, interact:false
};
function setPoints(v){ state.points=v; pointsEl.textContent=v; save.points=v; store(); }
function setHP(v){ state.hp=Math.max(0,Math.min(100,v)); hpBar.style.width=state.hp+'%'; if(state.hp<=0){ gameOver('HP Ã©puisÃ©s (tirs ennemis)'); } }
function setMission(t){ missionEl.textContent=t; }

// ====== THREE
if(!window.THREE || !THREE.WebGLRenderer){ status('WebGL non dispo â€” ton navigateur est trop ancien'); return; }
const gameEl=document.getElementById('game');
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(Math.min(window.devicePixelRatio||1,2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setClearColor(0x0b0d13,1);
gameEl.appendChild(renderer.domElement);

const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x0b0d13,40,300);
const camera=new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 2000);

const hemi=new THREE.HemisphereLight(0xbfd4ff,0x22334a,.65);
const sun=new THREE.DirectionalLight(0xffffff,.9); sun.position.set(60,100,40);
scene.add(hemi,sun);

// Monde simple, fiable
const ground=new THREE.Mesh(new THREE.PlaneGeometry(1600,1600), new THREE.MeshPhongMaterial({color:0x202633}));
ground.rotation.x=-Math.PI/2; ground.receiveShadow=true; scene.add(ground);
const obstacles=[];
const addObstacle=o=>{ const box=new THREE.Box3().setFromObject(o).expandByScalar(.4); obstacles.push(box); };
const roadMat=new THREE.MeshStandardMaterial({color:0x3a3e4d, roughness:.98});
for(let i=-14;i<=14;i++){
  const r1=new THREE.Mesh(new THREE.BoxGeometry(1600,.3,20),roadMat); r1.position.set(0,.01,i*42); scene.add(r1);
  const r2=new THREE.Mesh(new THREE.BoxGeometry(20,.3,1600),roadMat); r2.position.set(i*42,.01,0); scene.add(r2);
}
const buildMat=new THREE.MeshStandardMaterial({color:0x283257, metalness:.2, roughness:.85});
for(let x=-10;x<=10;x++){
  for(let z=-10;z<=10;z++){
    if((Math.abs(x)<=1 && Math.abs(z)<=1) || Math.random()<0.5) continue;
    const h=7+Math.random()*24, w=8+Math.random()*6, d=8+Math.random()*6;
    const b=new THREE.Mesh(new THREE.BoxGeometry(w,h,d), buildMat);
    b.position.set(x*42 + (Math.random()*12-6), h/2, z*42 + (Math.random()*12-6));
    scene.add(b); addObstacle(b);
  }
}

// Joueur (3e personne)
const player={pos:new THREE.Vector3(0,1.3,6), velY:0, onGround:true, yaw:0, pitch:0, obj:new THREE.Group()};
(function makePlayer(){
  const torso=new THREE.Mesh(new THREE.BoxGeometry(0.9,1.2,0.5), new THREE.MeshStandardMaterial({color:0x6bb6ff}));
  torso.position.y=1.6; player.obj.add(torso);
  const hips=new THREE.Mesh(new THREE.BoxGeometry(0.8,0.4,0.5), new THREE.MeshStandardMaterial({color:0x404a63}));
  hips.position.y=1.0; player.obj.add(hips);
  const head=new THREE.Mesh(new THREE.SphereGeometry(0.35,16,12), new THREE.MeshStandardMaterial({color:0xffe0c4}));
  head.position.y=2.2; player.obj.add(head);
  const eyeL=new THREE.Mesh(new THREE.SphereGeometry(0.05,8,8), new THREE.MeshStandardMaterial({color:0x111}));
  const eyeR=eyeL.clone(); eyeL.position.set(-0.12,2.28,0.3); eyeR.position.set(0.12,2.28,0.3);
  const handL=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.12,0.18), new THREE.MeshStandardMaterial({color:0xffd1b0}));
  const handR=handL.clone(); handL.position.set(-0.95,1.2,0.22); handR.position.set(0.95,1.2,0.22);
  const gun=new THREE.Mesh(new THREE.BoxGeometry(0.6,0.25,1.2), new THREE.MeshStandardMaterial({color:0x1f262d}));
  gun.position.set(0.6,1.4,0.25);
  player.obj.add(eyeL,eyeR,handL,handR,gun);
})();
scene.add(player.obj);

// CamÃ©ra suiveuse
const camCfg={dist:5.8,height:2.3}; const clamp=(v,a,b)=>Math.min(Math.max(v,a),b);
function updateCamera(){
  const behind=new THREE.Vector3(Math.sin(player.yaw),0,Math.cos(player.yaw)).multiplyScalar(camCfg.dist);
  const camPos=new THREE.Vector3(player.pos.x,player.pos.y+camCfg.height,player.pos.z).sub(behind);
  camera.position.copy(camPos); camera.lookAt(player.pos.x,player.pos.y+1.3,player.pos.z);
}
player.yaw=Math.PI*1.2; updateCamera();

// Objets mission & PNJ / ennemis
const beacon=new THREE.Mesh(new THREE.TorusGeometry(1.4,.18,12,48), new THREE.MeshStandardMaterial({color:0xffd44d,emissive:0x332200,emissiveIntensity:.7}));
beacon.position.set(24,1.5,-36); scene.add(beacon);
const targets=[]; const tgtMat=new THREE.MeshStandardMaterial({color:0xff3333,emissive:0x220000,emissiveIntensity:.5});
function addTarget(x,z){ const t=new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2),tgtMat.clone()); t.position.set(x,.6,z); scene.add(t); targets.push(t); }
addTarget(-12,-18); addTarget(24,22); addTarget(-28,36);

const enemies=[]; // simple capsules rouges
function spawnEnemy(x,z){
  const e=new THREE.Mesh(new THREE.CapsuleGeometry(.45,1.0,6,10), new THREE.MeshStandardMaterial({color:0xff6666}));
  e.position.set(x,1.2,z); e.userData={hp:60, tShoot:0, speed:3+Math.random()*1.5};
  scene.add(e); enemies.push(e);
}
spawnEnemy(18,18); spawnEnemy(-22,6); spawnEnemy(40,-10);

// PNJ hommes/femmes
const pnj=[];
function spawnPNJ(n=20){
  for(let i=0;i<n;i++){
    const g=new THREE.Group();
    const sex=(i%2===0)?'male':'female';
    const col = sex==='male'?0xffc97a:0xffa6c2;
    const body=new THREE.Mesh(new THREE.CapsuleGeometry(.45,1.0,6,10), new THREE.MeshStandardMaterial({color:col}));
    body.position.y=1.2; g.add(body);
    const head=new THREE.Mesh(new THREE.SphereGeometry(0.28,12,10), new THREE.MeshStandardMaterial({color:0xffe0c4}));
    head.position.y=2.0; g.add(head);
    const eye=new THREE.Mesh(new THREE.SphereGeometry(0.05,8,8), new THREE.MeshStandardMaterial({color:0x111}));
    const eye2=eye.clone(); eye.position.set(-.09,2.06,.26); eye2.position.set(.09,2.06,.26); g.add(eye,eye2);
    g.position.set((Math.random()-.5)*220,0,(Math.random()-.5)*220);
    scene.add(g);
    pnj.push({mesh:g, v:new THREE.Vector3((Math.random()-.5),0,(Math.random()-.5)).normalize().multiplyScalar(2+Math.random()*2.5), chill: 2+Math.random()*4, scared:0});
  }
}
spawnPNJ(22);

// ====== UI
function gameOver(why){ document.getElementById('overWhy').textContent=why||'HP Ã©puisÃ©s'; document.getElementById('over').style.display='flex'; state.running=false; }
document.getElementById('btnRetry').onclick=()=>location.reload();
document.getElementById('btnSettings').onclick=()=>{ document.getElementById('panel').style.display='block'; };
document.getElementById('closePanel').onclick=()=>{ document.getElementById('panel').style.display='none'; };
document.getElementById('sens').addEventListener('input',e=>{ state.sens=+e.target.value; document.getElementById('sensVal').textContent=state.sens.toFixed(1); save.sens=state.sens; store(); });
document.getElementById('invY').addEventListener('change',e=>{ state.invY=e.target.checked; save.invY=state.invY; store(); });
document.getElementById('miniOn').addEventListener('change',e=>{ state.mini=e.target.checked; save.mini=state.mini; store(); });
document.getElementById('enemyDmg').addEventListener('change',e=>{ state.enemyDmg=e.target.checked; save.enemyDmg=state.enemyDmg; store(); });

// ContrÃ´les Ã  lâ€™Ã©cran (PC + mobile)
function bindHold(el, on, off){
  const start=(e)=>{ e.preventDefault(); on(); document.addEventListener('mouseup',end); };
  const end=()=>{ off(); document.removeEventListener('mouseup',end); };
  el.addEventListener('mousedown',start);
  el.addEventListener('touchstart',e=>{ e.preventDefault(); on(); },{passive:false});
  el.addEventListener('touchend',e=>{ e.preventDefault(); off(); },{passive:false});
}
bindHold(document.querySelector('.d[data-k="up"]'),   ()=>state.mv.up=1,   ()=>state.mv.up=0);
bindHold(document.querySelector('.d[data-k="down"]'), ()=>state.mv.down=1, ()=>state.mv.down=0);
bindHold(document.querySelector('.d[data-k="left"]'), ()=>state.mv.left=1, ()=>state.mv.left=0);
bindHold(document.querySelector('.d[data-k="right"]'),()=>state.mv.right=1,()=>state.mv.right=0);
bindHold(document.getElementById('btnSprint'), ()=>state.sprint=true, ()=>state.sprint=false);
document.getElementById('btnJump').addEventListener('mousedown',()=>state.jump=true);
document.getElementById('btnJump').addEventListener('touchstart',e=>{ e.preventDefault(); state.jump=true; },{passive:false});
document.getElementById('btnInteract').addEventListener('mousedown',()=>state.interact=true);
document.getElementById('btnInteract').addEventListener('touchstart',e=>{ e.preventDefault(); state.interact=true; setTimeout(()=>state.interact=false,180); },{passive:false});
document.getElementById('btnFire').addEventListener('mousedown',()=>fire());
document.getElementById('btnFire').addEventListener('touchstart',e=>{ e.preventDefault(); fire(); },{passive:false});

// Pad camÃ©ra (drag)
(function(){
  const pad=document.getElementById('lookPad'), knob=document.getElementById('lookKnob');
  let active=false, cx=0,cy=0,R=0;
  function setVal(x,y){
    const dx=x-cx, dy=y-cy; const L=Math.hypot(dx,dy); const r=Math.min(L,R);
    const nx=dx/(L||1)*r, ny=dy/(L||1)*r;
    knob.style.transform=`translate(${nx}px,${ny}px) translate(-50%,-50%)`;
    state.look.x = nx/R; state.look.y = ny/R;
  }
  const start=(e)=>{ active=true; const rect=pad.getBoundingClientRect(); cx=rect.left+rect.width/2; cy=rect.top+rect.height/2; R=rect.width/2-24; setVal(e.clientX||e.touches[0].clientX, e.clientY||e.touches[0].clientY); };
  const move=(e)=>{ if(!active) return; setVal(e.clientX||e.touches[0].clientX, e.clientY||e.touches[0].clientY); };
  const end=()=>{ active=false; state.look.x=0; state.look.y=0; knob.style.transform='translate(-50%,-50%)'; };
  pad.addEventListener('mousedown',start); window.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
  pad.addEventListener('touchstart',e=>{ e.preventDefault(); start(e.touches[0]); },{passive:false});
  window.addEventListener('touchmove',e=>{ if(!active) return; move(e.touches[0]); },{passive:false});
  window.addEventListener('touchend',end,{passive:false});
})();

// Tir
const ray=new THREE.Raycaster();
function fire(){
  if(!state.running) return;
  ray.setFromCamera(new THREE.Vector2(0,0), camera);
  const hits=[...targets, ...enemies];
  const inter=ray.intersectObjects(hits,false);
  if(inter.length){
    const obj=inter[0].object;
    if(targets.includes(obj)){
      obj.visible=false; targets.splice(targets.indexOf(obj),1);
      missions.hit++; setPoints(state.points+25);
    } else {
      obj.userData.hp -= 25;
      if(obj.userData.hp<=0){ setPoints(state.points+60); obj.visible=false; enemies.splice(enemies.indexOf(obj),1); }
    }
  }
}

// DÃ©placements
const collidesXZ=(x,z)=>{ const box=new THREE.Box3(new THREE.Vector3(x-.5,0,z-.5), new THREE.Vector3(x+.5,3,z+.5)); for(const ob of obstacles){ if(ob.intersectsBox(box)) return true; } return false; };
function stepPlayer(dt){
  // camÃ©ra
  const m=2.3*state.sens;
  player.yaw  -= state.look.x * dt * m;
  player.pitch-= (state.invY?-1:1)*(-state.look.y) * dt * m;
  player.pitch=clamp(player.pitch,-1.2,1.2);
  // dpad -> vector
  let mx=(state.mv.right?1:0)-(state.mv.left?1:0);
  let my=(state.mv.up?1:0)-(state.mv.down?1:0);
  const len=Math.hypot(mx,my)||1; mx/=len; my/=len;
  const base= state.sprint?9.2:6.2;
  const yaw=player.yaw;
  const fwd=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
  const right=new THREE.Vector3(fwd.z,0,-fwd.x);
  const dx=(right.x*mx+fwd.x*my)*base*dt, dz=(right.z*mx+fwd.z*my)*base*dt;
  const nx=player.pos.x+dx, nz=player.pos.z+dz;
  if(!collidesXZ(nx,nz)){ player.pos.x=nx; player.pos.z=nz; }
  // saut & gravitÃ©
  if(state.jump && player.onGround){ player.velY=8; player.onGround=false; state.jump=false; }
  player.velY+=-24*dt; player.pos.y+=player.velY*dt;
  if(player.pos.y<1.3){ player.pos.y=1.3; player.velY=0; player.onGround=true; }
  player.obj.position.copy(player.pos); player.obj.rotation.y=player.yaw;
  updateCamera();
}

// IA ennemie + PNJ
function flashHit(){ const el=$('hit'); el.style.display='block'; clearTimeout(flashHit._t); flashHit._t=setTimeout(()=>el.style.display='none',150); }
function stepAI(dt){
  const shootEvery=1.0;
  enemies.forEach(e=>{
    if(!e.visible) return;
    const dx=player.pos.x-e.position.x, dz=player.pos.z-e.position.z; const d=Math.hypot(dx,dz);
    if(d<40){
      const nx=e.position.x + (dx/d)*e.userData.speed*dt;
      const nz=e.position.z + (dz/d)*e.userData.speed*dt;
      e.position.set(nx,1.2,nz);
      e.userData.tShoot += dt;
      if(state.enemyDmg && e.userData.tShoot>shootEvery){
        e.userData.tShoot=0;
        const hit = Math.random() < Math.max(0.15, 1.0 - d/50);
        if(hit){ setHP(state.hp - (8 + Math.random()*6)); flashHit(); }
      }
    }
  });
  pnj.forEach(p=>{
    p.chill -= dt;
    if(p.chill<=0){ p.v.set((Math.random()-.5),0,(Math.random()-.5)).normalize().multiplyScalar(1.5+Math.random()*2.5); p.chill=2+Math.random()*4; }
    const dx= p.mesh.position.x - player.pos.x, dz= p.mesh.position.z - player.pos.z;
    const d=Math.hypot(dx,dz);
    if(d<2.0){ p.v.add(new THREE.Vector3(dx/d,0,dz/d).multiplyScalar(8)); if(d<1.0){ setPoints(Math.max(0,state.points-1)); } }
    p.v.multiplyScalar(0.98);
    p.mesh.position.x += p.v.x*dt; p.mesh.position.z += p.v.z*dt;
  });
}

// Mini-map & missions
const map=$('map'), mctx=map.getContext('2d');
function drawMap(){
  $('mapWrap').style.display= state.mini? 'block':'none'; if(!state.mini) return;
  const W=map.width,H=map.height; mctx.clearRect(0,0,W,H); mctx.fillStyle="#0e1320"; mctx.fillRect(0,0,W,H);
  const scale=2, cx=player.pos.x, cz=player.pos.z; const tx=x=> W/2+(x-cx)/scale, tz=z=> H/2+(z-cz)/scale;
  mctx.strokeStyle="#2a3044"; for(let i=-6;i<=6;i++){ mctx.beginPath(); mctx.moveTo(0, tz(i*42)); mctx.lineTo(W, tz(i*42)); mctx.stroke(); mctx.beginPath(); mctx.moveTo(tx(i*42),0); mctx.lineTo(tx(i*42),H); mctx.stroke(); }
  mctx.fillStyle="#ffd44d"; mctx.beginPath(); mctx.arc(tx(beacon.position.x), tz(beacon.position.z), 4,0,Math.PI*2); mctx.fill();
  mctx.fillStyle="#ff3b3b"; enemies.forEach(e=>{ if(e.visible){ mctx.fillRect(tx(e.position.x)-2, tz(e.position.z)-2,4,4); } });
  mctx.fillStyle="#ffaa44"; pnj.forEach(p=>{ mctx.fillRect(tx(p.mesh.position.x)-2, tz(p.mesh.position.z)-2,4,4); });
  mctx.fillStyle="#6bb6ff"; mctx.beginPath(); mctx.arc(W/2,H/2,5,0,Math.PI*2); mctx.fill();
}
const missions={reached:false, hit:0, talked:0};
function stepMissions(){
  if(!missions.reached){
    setMission("1) Atteins l'anneau jaune");
    const d=Math.hypot(player.pos.x-beacon.position.x, player.pos.z-beacon.position.z);
    if(d<2){ missions.reached=true; setPoints(state.points+150); beacon.visible=false; }
  } else if(missions.hit<3){
    setMission(`2) DÃ©truis 3 cibles (${missions.hit}/3)`);
  } else if(missions.talked<2){
    setMission(`3) Parler Ã  2 PNJ (${missions.talked}/2)`);
    const near=pnj.find(p=> Math.hypot(p.mesh.position.x-player.pos.x, p.mesh.position.z-player.pos.z) < 2.2);
    if(near && state.interact){ missions.talked++; state.interact=false; setPoints(state.points+50); }
    if(missions.talked>=2){ setPoints(state.points+200); setMission("Missions terminÃ©es âœ“"); }
  } else setMission("Missions terminÃ©es âœ“");
}

// Boucle
let last=0;
function loop(t){
  if(!state.running) return;
  const dt=Math.min(.033,(t-last)/1000||.016); last=t;
  state.timeAcc+=dt; if(state.timeAcc>=.5){ state.timeAcc-=.5; setPoints(state.points+1); }
  stepPlayer(dt); stepAI(dt); stepMissions(); drawMap();
  renderer.render(scene,camera);
  requestAnimationFrame(loop);
}

// DÃ©marrage
function start(){ setPoints(save.points); setHP(100); state.running=true; status('ok â€” joue !'); requestAnimationFrame(loop); }
start();

// Resize
window.addEventListener('resize',()=>{ renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); });

// Infos utiles
status('ok â€” si Ã©cran noir: vÃ©rifie que le CDN three.min.js charge bien (rÃ©seau).');
})();
</script>
</body>
</html>
