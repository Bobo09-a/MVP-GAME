<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>MVP 3D – City/Missions (solo)</title>
  <style>
    :root{
      --bg:#0b0f1a; --hud:#0f1424cc; --hud2:#1a2240; --txt:#e9ecff; --muted:#aab1ff;
      --accent:#ffd44d; --ok:#1dde7d; --bad:#ff5a66; --buy:#35b7ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;overflow:hidden}
    .hud{position:fixed;inset:0;pointer-events:none}
    .row{display:flex;gap:.5rem;align-items:center}
    .topbar{position:absolute;left:12px;top:12px;background:var(--hud);backdrop-filter:blur(6px);border:1px solid #ffffff1a;border-radius:14px;padding:10px 12px;pointer-events:auto}
    .topbar b{color:var(--accent)}
    .buttons{position:absolute;right:12px;top:12px;display:flex;gap:8px}
    .btn{pointer-events:auto;background:var(--hud);color:var(--txt);border:1px solid #ffffff1a;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#1a2240cc}
    .mission{position:absolute;left:12px;bottom:12px;background:var(--hud);border:1px solid #ffffff1a;border-radius:14px;padding:10px 12px;max-width:min(460px,92vw);pointer-events:auto}
    .centerPrompt{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--hud);border:1px solid #ffffff1a;border-radius:18px;padding:18px 16px;text-align:center;max-width:520px;pointer-events:auto}
    .centerPrompt h1{margin:0 0 6px;font-size:22px}
    .centerPrompt p{margin:0 0 10px;color:var(--muted)}
    .shop{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;pointer-events:auto}
    .card{background:#0f1424; border:1px solid #ffffff1a;border-radius:16px; padding:14px; width:min(900px,96vw); max-height:88vh; overflow:auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .item{background:#0b1020;border:1px solid #ffffff14;border-radius:14px;padding:12px}
    .price{color:var(--accent)}
    .buy{display:inline-block;margin-top:8px;padding:8px 10px;border-radius:10px;background:var(--buy);color:#00172a;font-weight:700;cursor:pointer}
    .owned{display:inline-block;margin-top:8px;padding:8px 10px;border-radius:10px;background:var(--ok);color:#001a0c;font-weight:700}
    .closeX{position:sticky; top:0; display:flex; justify-content:end}
    .rotate{position:fixed; inset:0; background:#000c; color:#fff; display:none; align-items:center; justify-content:center; text-align:center; padding:24px; z-index:50}
    .rotate span{background:#111a; border:1px solid #fff2; padding:14px 16px; border-radius:12px}

    /* Virtual sticks */
    .sticks{position:fixed; inset:0; pointer-events:none}
    .stick{position:absolute; width:140px; height:140px; border-radius:50%; background:#ffffff0d; border:1px dashed #ffffff33; bottom:20px; pointer-events:auto; touch-action:none}
    #stickL{left:20px}
    #stickR{right:20px}
    .knob{position:absolute; left:50%; top:50%; width:64px; height:64px; transform:translate(-50%,-50%); border-radius:50%; background:#ffffff2b; border:1px solid #ffffff5a}

    @media (max-width:980px){
      .buttons{right:8px; top:8px}
      .btn{padding:8px 10px}
      .topbar{left:8px; top:8px}
      .mission{left:8px; bottom:8px}
    }
  </style>
</head>
<body>
  <div class="hud">
    <div class="topbar" id="hudInfo">
      <div class="row"><b>Points:</b>&nbsp;<span id="hudPoints">0</span> • <b>État:</b>&nbsp;<span id="hudState">à pied</span></div>
      <div class="row" style="margin-top:4px"><b>Inventaire:</b>&nbsp;<span id="hudInv">(vide)</span></div>
    </div>
    <div class="buttons">
      <button class="btn" id="btnStart">Jouer</button>
      <button class="btn" id="btnMission">Mission</button>
      <button class="btn" id="btnShop">Boutique</button>
      <button class="btn" id="btnVehicle" style="display:none">Entrer véhicule</button>
    </div>
    <div class="mission" id="hudMission">
      <div><b>Mission courante:</b> <span id="missionTitle">aucune</span></div>
      <div style="color:var(--muted)" id="missionHint">Appuie sur <b>Mission</b> pour commencer un objectif rapide.</div>
    </div>
    <div class="centerPrompt" id="centerPrompt">
      <h1>MVP 3D – Ville & Missions (Solo)</h1>
      <p>Desktop: clique <b>Jouer</b> puis bouge avec <b>ZQSD / WASD</b>, souris pour viser, <b>Espace</b> pour sauter.<br/>Mobile: utilise les deux sticks virtuels (gauche = déplacement, droit = caméra).</p>
      <div class="row" style="justify-content:center; gap:10px; margin-top:8px">
        <button class="btn" id="btnPlayA">Jouer</button>
        <button class="btn" id="btnShopA">Boutique</button>
      </div>
      <small style="display:block;margin-top:10px;color:#9ea6ff;opacity:.9">Prototypé pour GitHub Pages • Pas de serveur, sauvegarde locale uniquement</small>
    </div>
  </div>

  <div class="shop" id="shop">
    <div class="card">
      <div class="closeX"><button class="btn" id="btnCloseShop">Fermer</button></div>
      <h2 style="margin:6px 0 10px">Boutique (monnaie: points gagnés)</h2>
      <div class="grid" id="shopGrid"></div>
    </div>
  </div>

  <div class="rotate" id="rotateWarn"><span>Tournez votre appareil en mode <b>paysage</b> pour jouer confortablement.</span></div>

  <!-- Virtual Sticks for mobile -->
  <div class="sticks" id="sticks" style="display:none">
    <div id="stickL" class="stick"><div class="knob"></div></div>
    <div id="stickR" class="stick"><div class="knob"></div></div>
  </div>

  <script type="module">
    // === Imports (Three.js) ===
    import * as THREE from 'https://unpkg.com/three@0.161.0/build/three.module.js';
    import { PointerLockControls } from 'https://unpkg.com/three@0.161.0/examples/jsm/controls/PointerLockControls.js';

    // === Utilities ===
    const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    const clamp = (v, a, b) => Math.min(Math.max(v, a), b);
    const dist2D = (ax, az, bx, bz) => Math.hypot(ax - bx, az - bz);

    // === Save/Load (no DB: localStorage only) ===
    const SAVE_KEY = 'mvp3d_save_v1';
    let save = null;
    function loadSave(){
      try{ save = JSON.parse(localStorage.getItem(SAVE_KEY)||'null') }catch(e){ save=null }
      if(!save){
        save = { points: 0, owned: { pistol:false, rifle:false, outfit:false, car:false, heli:false, plane:false, house:false }, lastPlayed: Date.now() };
      }
      updateHUD();
    }
    function persist(){ localStorage.setItem(SAVE_KEY, JSON.stringify(save)) }

    // === Economy & Shop ===
    const SHOP_ITEMS = [
      { id:'pistol', name:'Pistolet', price:150, desc:'Arme de base. Esthétique pour l’instant (placeholders).'},
      { id:'rifle',  name:'Fusil d'assaut', price:500, desc:'Portée et dégâts fictifs (MVP).'},
      { id:'outfit', name:'Tenue (skins)', price:200, desc:'Change la couleur du joueur.'},
      { id:'car',    name:'Voiture', price:800, desc:'Déplacements 2x plus rapides.'},
      { id:'heli',   name:'Hélicoptère', price:2000, desc:'Active le vol vertical (mode aérien).'},
      { id:'plane',  name:'Avion', price:3000, desc:'Vol plus rapide en palier.'},
      { id:'house',  name:'Maison', price:1500, desc:'Point de départ personnalisé (à venir).'},
    ];

    function formatInv(){
      const owned = Object.entries(save.owned).filter(([,v])=>v).map(([k])=>{
        const item = SHOP_ITEMS.find(it=>it.id===k); return item? item.name : k;
      });
      return owned.length? owned.join(', ') : '(vide)';
    }

    function buildShop(){
      const grid = document.getElementById('shopGrid');
      grid.innerHTML = '';
      for(const it of SHOP_ITEMS){
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `<div style="font-weight:700">${it.name}</div>
                         <div class="price">${it.price} pts</div>
                         <div style="margin-top:6px;color:#9fb2ff">${it.desc}</div>`;
        if(save.owned[it.id]){
          const tag = document.createElement('div'); tag.className='owned'; tag.textContent='Déjà possédé'; div.appendChild(tag);
        } else {
          const btn = document.createElement('button'); btn.className='buy'; btn.textContent='Acheter';
          btn.onclick = ()=>{
            if(save.points >= it.price){ save.points -= it.price; save.owned[it.id]=true; persist(); buildShop(); updateHUD(); applyOwnershipEffects(); }
            else flashMsg('Pas assez de points. Gagne des points via missions ou temps de jeu.');
          };
          div.appendChild(btn);
        }
        grid.appendChild(div);
      }
    }

    // === Flash helper ===
    function flashMsg(text){
      const el = document.createElement('div');
      el.textContent = text;
      el.style.cssText = 'position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#111b;backdrop-filter:blur(6px);border:1px solid #fff2;color:#fff;padding:10px 12px;border-radius:12px;z-index:40';
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 1800);
    }

    // === THREE.js scene ===
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 1.75));
    renderer.setSize(innerWidth, innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0f1a);
    scene.fog = new THREE.Fog(0x0b0f1a, 120, 420);

    const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0, 1.8, 6);

    // Lights
    const hemi = new THREE.HemisphereLight(0xe8f0ff, 0x08121e, 0.8);
    const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(40,60,30); dir.castShadow = false;
    scene.add(hemi, dir);

    // Ground
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(1000,1000),
      new THREE.MeshStandardMaterial({ color:0x1e6a3a, roughness:1, metalness:0 })
    );
    ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; scene.add(ground);

    // Roads grid
    const roads = new THREE.Group();
    const roadMat = new THREE.MeshStandardMaterial({ color:0x323640, roughness:.9 });
    for(let i=-10;i<=10;i++){
      const r1 = new THREE.Mesh(new THREE.PlaneGeometry(1000,6), roadMat); r1.rotation.x=-Math.PI/2; r1.position.z = i*20; roads.add(r1);
      const r2 = new THREE.Mesh(new THREE.PlaneGeometry(6,1000), roadMat); r2.rotation.x=-Math.PI/2; r2.position.x = i*20; roads.add(r2);
    }
    scene.add(roads);

    // Buildings
    const buildings = new THREE.Group(); scene.add(buildings);
    const obstacles = []; // Box3 list for collisions
    const bMat = new THREE.MeshStandardMaterial({ color:0x2a2e54, roughness:.8, metalness:0.05 });
    const rng = (a,b)=> a + Math.random()*(b-a);
    for(let gx=-9; gx<=9; gx++){
      for(let gz=-9; gz<=9; gz++){
        if(Math.abs(gx)<2 && Math.abs(gz)<2) continue; // keep spawn area clean
        if(Math.random()<0.7){ // many city blocks occupied
          // Leave a gap so buildings don't overlap roads
          const w = rng(6, 14), d = rng(6, 14), h = rng(8, 38);
          const mx = gx*20 + rng(-5,5); const mz = gz*20 + rng(-5,5);
          const mesh = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), bMat);
          mesh.position.set(mx, h/2, mz);
          buildings.add(mesh);
          const box = new THREE.Box3().setFromObject(mesh).expandByScalar(0.6); // padding for collisions
          obstacles.push(box);
        }
      }
    }

    // Simple beacon (mission target)
    const beacon = new THREE.Mesh(new THREE.TorusGeometry(2.3, 0.25, 10, 40), new THREE.MeshStandardMaterial({ color:0xffd44d, emissive:0x332200, emissiveIntensity:0.6 }));
    beacon.rotateX(Math.PI/2); beacon.visible=false; scene.add(beacon);

    // Player & Controls
    const controls = new PointerLockControls(camera, renderer.domElement);
    let velocity = new THREE.Vector3();
    let direction = new THREE.Vector3();
    let onGround = true;
    let speedBase = 12; // m/s walking
    let speedMult = 1;  // vehicle boost etc.

    const keys = { forward:false, backward:false, left:false, right:false, jump:false };
    function onKey(e, down){
      switch(e.code){
        case 'KeyW': case 'ArrowUp': case 'KeyZ': keys.forward=down; break;
        case 'KeyS': case 'ArrowDown': keys.backward=down; break;
        case 'KeyA': case 'ArrowLeft': case 'KeyQ': keys.left=down; break;
        case 'KeyD': case 'ArrowRight': keys.right=down; break;
        case 'Space': if(down && onGround){ velocity.y = 6; onGround=false; } break;
      }
    }
    window.addEventListener('keydown', e=>onKey(e,true));
    window.addEventListener('keyup', e=>onKey(e,false));

    // Mobile look + move via virtual sticks
    class VirtualStick{
      constructor(root){
        this.root=root; this.knob=root.querySelector('.knob');
        this.active=false; this.value={x:0,y:0}; this.center={x:0,y:0}; this.r=70;
        root.addEventListener('pointerdown', e=>{ this.active=true; this.center={x:e.clientX,y:e.clientY}; this.root.setPointerCapture(e.pointerId); this.updateKnob(e.clientX,e.clientY); });
        root.addEventListener('pointermove', e=>{ if(!this.active) return; this.updateKnob(e.clientX,e.clientY); });
        const end = e=>{ this.active=false; this.value={x:0,y:0}; this.knob.style.left='50%'; this.knob.style.top='50%'; };
        root.addEventListener('pointerup', end); root.addEventListener('pointercancel', end);
      }
      updateKnob(x,y){
        const dx = x - this.center.x; const dy = y - this.center.y; const mag = Math.hypot(dx,dy) || 1;
        const clamped = Math.min(mag, this.r); const nx = dx/mag*clamped; const ny = dy/mag*clamped;
        this.knob.style.left = `calc(50% + ${nx}px)`; this.knob.style.top = `calc(50% + ${ny}px)`;
        this.value = { x: nx/this.r, y: ny/this.r };
      }
    }

    const mobile = { enabled:isMobile, yaw:0, pitch:0, stickL:null, stickR:null };
    if(isMobile){
      document.getElementById('sticks').style.display='block';
      mobile.stickL = new VirtualStick(document.getElementById('stickL'));
      mobile.stickR = new VirtualStick(document.getElementById('stickR'));
      // Disable pointer lock interactions on mobile
    }

    // Collision helpers
    const playerRadius = 0.6;
    function collides(next){
      const p = new THREE.Vector3(next.x, next.y, next.z);
      // Build a small box around player to check intersection with obstacles
      const box = new THREE.Box3(new THREE.Vector3(p.x-playerRadius, p.y-1.0, p.z-playerRadius), new THREE.Vector3(p.x+playerRadius, p.y+1.6, p.z+playerRadius));
      for(const ob of obstacles){ if(ob.intersectsBox(box)) return true; }
      return false;
    }

    function tryMove(deltaX, deltaY, deltaZ){
      const obj = controls.getObject();
      const next = obj.position.clone().add(new THREE.Vector3(deltaX, deltaY, deltaZ));
      if(!collides(next)) obj.position.copy(next);
    }

    // Missions (very simple for MVP)
    const missions = [
      { id:'go_beacon', title:'Rejoindre le point de rendez-vous', hint:'Suis l'anneau lumineux sur ta carte. Récompense: +120 pts', reward:120 },
      { id:'sprint', title:'Sprint de ville', hint:'Parcourir 300 m le long des routes. Récompense: +180 pts', reward:180 },
    ];
    let currentMission = null; let missionProgress = 0; let missionActive=false;
    function startMission(){
      if(missionActive) { flashMsg('Mission déjà en cours.'); return; }
      const m = missions[Math.floor(Math.random()*missions.length)];
      currentMission = m; missionProgress=0; missionActive=true; updateMissionHUD();
      if(m.id==='go_beacon'){
        const px = Math.round((Math.random()*16-8))*20; const pz = Math.round((Math.random()*16-8))*20;
        beacon.position.set(px, 2, pz); beacon.visible=true;
      }
    }
    function completeMission(){
      if(!missionActive) return;
      flashMsg('Mission accomplie! +' + currentMission.reward + ' pts');
      save.points += currentMission.reward; persist();
      missionActive=false; beacon.visible=false; currentMission=null; missionProgress=0; updateMissionHUD(); updateHUD();
    }
    function updateMission(delta){
      if(!missionActive || !currentMission) return;
      if(currentMission.id==='go_beacon'){
        const p = controls.getObject().position; const d = dist2D(p.x,p.z, beacon.position.x, beacon.position.z);
        if(d < 3.2) completeMission();
      } else if(currentMission.id==='sprint'){
        // Measure distance moved along XZ
        missionProgress += Math.abs(velocity.x*delta) + Math.abs(velocity.z*delta);
        if(missionProgress >= 300) completeMission();
      }
    }

    // Day/Night cycle (ambient change)
    let dayT = 0; // 0..1
    function updateDayNight(delta){
      dayT = (dayT + delta*0.01) % 1; // ~100s per day
      const sky = new THREE.Color().setHSL(0.62, 0.45, 0.12 + 0.65*Math.max(0, Math.sin(dayT*Math.PI)));
      scene.background.copy(sky);
      hemi.intensity = 0.5 + 0.5*Math.max(0, Math.sin(dayT*Math.PI));
      dir.intensity  = 0.3 + 0.4*Math.max(0, Math.sin(dayT*Math.PI));
    }

    // Points by time spent
    let timeBank = 0; // accumulate seconds
    function updatePointsByTime(delta){
      timeBank += delta; // seconds
      // 1 point / 10s
      const give = Math.floor(timeBank / 10);
      if(give>0){ save.points += give; timeBank -= give*10; persist(); updateHUD(); }
    }

    function updateHUD(){
      document.getElementById('hudPoints').textContent = Math.floor(save.points);
      document.getElementById('hudInv').textContent = formatInv();
      document.getElementById('btnVehicle').style.display = save.owned.car ? 'inline-block' : 'none';
    }

    function updateMissionHUD(){
      const t = document.getElementById('missionTitle');
      const h = document.getElementById('missionHint');
      if(missionActive && currentMission){ t.textContent = currentMission.title; h.textContent=currentMission.hint; }
      else { t.textContent = 'aucune'; h.textContent = 'Appuie sur Mission pour commencer un objectif rapide.'; }
    }

    function applyOwnershipEffects(){
      speedMult = (save.owned.car?2:1);
      document.getElementById('hudState').textContent = speedMult>1? 'en véhicule' : 'à pied';
      // Outfit → just tint beacon to show style (placeholder)
      beacon.material.color.set(save.owned.outfit? 0x7cf7ff : 0xffd44d);
    }

    // Vehicle enter/exit toggle (speed change only, for MVP)
    let inVehicle = false;
    function toggleVehicle(){
      if(!save.owned.car){ flashMsg('Tu dois acheter une voiture dans la Boutique.'); return; }
      inVehicle = !inVehicle; speedMult = inVehicle? 2 : 1; updateHUD(); document.getElementById('hudState').textContent = inVehicle? 'en véhicule' : 'à pied';
    }

    // Flight (heli/plane)
    function flightEnabled(){ return !!(save.owned.heli || save.owned.plane); }

    // Resize & orientation
    function onResize(){
      const w = innerWidth, h = innerHeight;
      renderer.setSize(w,h); camera.aspect=w/h; camera.updateProjectionMatrix();
      const rot = document.getElementById('rotateWarn');
      if(isMobile){ rot.style.display = (w < h) ? 'flex' : 'none'; }
    }
    window.addEventListener('resize', onResize);

    // === UI bindings ===
    const shopEl = document.getElementById('shop');
    document.getElementById('btnShop').onclick = ()=>{ buildShop(); shopEl.style.display='flex'; };
    document.getElementById('btnShopA').onclick = ()=>{ buildShop(); shopEl.style.display='flex'; };
    document.getElementById('btnCloseShop').onclick = ()=> shopEl.style.display='none';
    document.getElementById('btnMission').onclick = ()=> startMission();
    document.getElementById('btnVehicle').onclick = ()=> toggleVehicle();

    // Start / PointerLock
    function startPlay(){
      document.getElementById('centerPrompt').style.display='none';
      if(!isMobile){ controls.lock(); }
    }
    document.getElementById('btnStart').onclick = startPlay;
    document.getElementById('btnPlayA').onclick = startPlay;

    // === Main loop ===
    let prev = performance.now();
    function animate(now){
      const delta = Math.min(0.05, (now - prev)/1000); prev = now;

      // Movement (desktop)
      if(!isMobile){
        direction.set(Number(keys.right) - Number(keys.left), 0, Number(keys.backward) - Number(keys.forward));
        direction.normalize();
        const speed = speedBase*speedMult;
        const obj = controls.getObject();

        // Gravity & vertical
        velocity.y += onGround? 0 : -18*delta; // gravity
        // Horizontal intention
        const vx = direction.x * speed * delta;
        const vz = direction.z * speed * delta;
        // Convert to world space using camera yaw
        const yaw = obj.rotation.y;
        const dx = Math.cos(yaw)*vz + Math.sin(yaw)*vx;
        const dz = Math.sin(yaw)*vz - Math.cos(yaw)*vx;

        tryMove(dx, 0, dz);
        // Vertical move with collision simple (ground at y=1.8 baseline)
        tryMove(0, velocity.y*delta, 0);
        const p = obj.position;
        if(p.y <= 1.8){ p.y = 1.8; velocity.y = 0; onGround = true; } else onGround=false;
      }

      // Movement (mobile)
      if(isMobile){
        // Look
        mobile.yaw   += -mobile.stickR.value.x * 2.5 * delta; // left/right
        mobile.pitch += -mobile.stickR.value.y * 1.8 * delta; // up/down
        mobile.pitch = clamp(mobile.pitch, -Math.PI/3, Math.PI/3);
        camera.rotation.set(mobile.pitch, mobile.yaw, 0, 'YXZ');
        const forward = new THREE.Vector3(Math.sin(mobile.yaw), 0, -Math.cos(mobile.yaw));
        const right   = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0,1,0)).negate();
        const speed = speedBase*speedMult*0.9; // a bit slower on mobile
        const mv = mobile.stickL.value;
        const dx = (right.x*mv.x + forward.x*(-mv.y)) * speed * delta;
        const dz = (right.z*mv.x + forward.z*(-mv.y)) * speed * delta;

        const obj = controls.getObject(); // still use the same holder for position
        // Vertical (flight)
        let dy = 0;
        if(flightEnabled()){
          dy += (-mv.y>0.8? 1:0) * (save.owned.plane? 18:10) * delta; // pull up when pushing forward strongly
          dy += (mv.y>0.8? -1:0) * (save.owned.plane? 12:8) * delta;   // go down when pushing back strongly
        }
        tryMove(dx, dy, dz);
      }

      // Beacon spin
      if(beacon.visible){ beacon.rotation.z += 0.9*delta; }

      // Systems
      updateDayNight(delta);
      updateMission(delta);
      updatePointsByTime(delta);

      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }

    // Init
    loadSave(); buildShop(); applyOwnershipEffects(); onResize();
    scene.add(controls.getObject()); controls.getObject().position.set(0,1.8,6);
    requestAnimationFrame(animate);

    // Quality caps for weak devices
    if(isMobile && devicePixelRatio>1.5){ renderer.setPixelRatio(1.5); }

    // Prevent context menu on long-press mobile
    window.addEventListener('contextmenu', e=> e.preventDefault());
  </script>
</body>
</html>
