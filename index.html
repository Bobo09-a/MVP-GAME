<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Urban Ops — MVP 3D (solo)</title>
<style>
  :root{
    --bg:#0c0e12; --ui:#151a22; --ui2:#202938; --accent:#58a6ff; --ok:#37d67a; --warn:#ffb020; --danger:#ff5555;
    --txt:#e6ebff; --muted:#aab3c5;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Arial}
  #game{position:fixed;inset:0;overflow:hidden}
  canvas{display:block;position:absolute;inset:0}
  /* Top HUD */
  .hud{position:absolute;left:12px;top:12px;display:flex;gap:8px;align-items:center;z-index:10}
  .pill{background:rgba(21,26,34,.8);border:1px solid #2b3447;border-radius:999px;padding:8px 12px;font-weight:600}
  .btn{background:var(--ui2);border:1px solid #2b3447;border-radius:10px;padding:8px 12px;cursor:pointer;user-select:none}
  .btn:active{transform:scale(.98)}
  .muted{color:var(--muted)}
  /* Center message */
  #msg{position:absolute;left:50%;top:8%;transform:translateX(-50%);text-align:center;font-weight:700;background:rgba(12,14,18,.55);padding:8px 12px;border-radius:8px;border:1px solid #2b3447}
  /* Start screen */
  #menu{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg,#0b0d13,rgba(11,13,19,.7) 40%,rgba(11,13,19,.95));z-index:20}
  #card{width:min(520px,92vw);background:rgba(18,22,30,.9);border:1px solid #2b3447;border-radius:16px;padding:20px}
  #title{font-size:28px;margin:0 0 6px;font-weight:800;letter-spacing:.5px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}
  input[type=range]{width:220px}
  /* Mobile controls */
  .hud-mobile{position:absolute;inset:0;pointer-events:none}
  .stick{position:absolute;bottom:18px;width:160px;height:160px;border-radius:50%;background:rgba(32,41,56,.35);
         border:1px solid #2b3447;pointer-events:auto;touch-action:none}
  .knob{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:64px;height:64px;border-radius:50%;
        background:rgba(88,166,255,.85);border:2px solid rgba(255,255,255,.45)}
  #stickL{left:18px} #stickR{right:18px}
  .action{position:absolute;right:18px;bottom:190px;display:flex;gap:10px;pointer-events:auto}
  .action .btn{font-weight:800}
  .action2{position:absolute;right:18px;bottom:270px;pointer-events:auto}
  .badge{background:rgba(88,166,255,.2);border:1px solid #2b3447;padding:4px 8px;border-radius:8px}
  /* Shop & small panels (placeholders kept minimal) */
  #panel{position:absolute;right:12px;top:12px;background:rgba(21,26,34,.85);border:1px solid #2b3447;border-radius:12px;padding:10px;z-index:10}
  @media (max-width:900px){ .pill{padding:6px 10px} #msg{top:4%} }
</style>
</head>
<body>
<div id="game"></div>

<!-- HUD -->
<div class="hud">
  <div class="pill">Points: <span id="points">0</span></div>
  <div class="pill">Mission: <span id="mission">—</span></div>
  <div class="btn" id="btnSettings">Réglages</div>
  <div class="btn" id="btnShop">Boutique</div>
</div>
<div id="panel" style="display:none">
  <div style="font-weight:700;margin-bottom:6px">Réglages</div>
  <div class="row"><span class="muted">Sensibilité:</span><input type="range" min="0.3" max="3" step="0.1" id="sens"><span class="badge" id="sensVal">1.0</span></div>
  <div class="row"><label><input type="checkbox" id="invY"> Inverser axe Y</label></div>
  <div class="row"><div class="btn" id="closePanel">Fermer</div></div>
</div>

<div id="msg">Clique “JOUER” — PC: WASD + souris | Mobile: joysticks + FEU</div>

<!-- Mobile HUD -->
<div class="hud-mobile" id="hudMobile" style="display:none">
  <div id="stickL" class="stick"><div class="knob" id="knobL"></div></div>
  <div id="stickR" class="stick"><div class="knob" id="knobR"></div></div>
  <div class="action2"><div class="btn" id="btnSprint">SPRINT</div></div>
  <div class="action">
    <div class="btn" id="btnJump">SAUT</div>
    <div class="btn" id="btnFire" style="background:rgba(255,85,85,.85);border-color:#ff8b8b">FEU</div>
  </div>
</div>

<!-- Start menu -->
<div id="menu">
  <div id="card">
    <h1 id="title">URBAN OPS (MVP solo)</h1>
    <p class="muted" style="margin-top:0">Mini-monde 3D, missions rapides, tir 9 mm. Jouable PC & mobile (paysage). Sauvegarde locale.</p>
    <div class="row">
      <div class="pill">Points actuels: <b id="pStart">0</b></div>
      <div class="badge">+1000 offerts au 1er lancement</div>
    </div>
    <div class="row">
      <div class="btn" id="play">JOUER</div>
      <div class="btn" id="how">Commandes</div>
    </div>
    <div class="row">
      <span class="muted">Sensibilité caméra:</span>
      <input type="range" min="0.3" max="3" step="0.1" id="sensStart"><span class="badge" id="sensStartVal">1.0</span>
    </div>
    <div class="row"><label><input type="checkbox" id="invYStart"> Inverser axe Y</label></div>
    <details style="margin-top:10px"><summary style="cursor:pointer">Détails missions</summary>
      <ul>
        <li><b>Mission 1:</b> Rejoindre l’anneau lumineux (beacon) → +150 pts</li>
        <li><b>Mission 2:</b> Détruire 3 cibles rouges → +300 pts</li>
        <li><b>Temps de jeu:</b> +1 pt / 0,5 s</li>
      </ul>
    </details>
  </div>
</div>

<!-- Three.js -->
<script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>

<script>
(()=>{
// ---------- State & Save ----------
const save = JSON.parse(localStorage.getItem('urbanops_save')||'{}');
if(!save.init){ save.init=true; save.points=1000; save.sens=1.2; save.invY=false; }
const state = {
  running:false, points: save.points||0, timeAcc:0, // for time-reward
  sens: save.sens||1.2, invY: !!save.invY,
  mobile: 'ontouchstart' in window || navigator.maxTouchPoints>0,
  keys:{}, move:{x:0,y:0}, look:{x:0,y:0}, sprint:false, jump:false, firing:false,
  missionIndex:0, missionText:'—', mission1Done:false, mission2Hits:0,
};
document.getElementById('pStart').textContent = state.points;
document.getElementById('sensStart').value = state.sens;
document.getElementById('sensStartVal').textContent = state.sens.toFixed(1);
document.getElementById('sens').value = state.sens;
document.getElementById('sensVal').textContent = state.sens.toFixed(1);
document.getElementById('invYStart').checked = state.invY;
document.getElementById('invY').checked = state.invY;

// ---------- Three.js Setup ----------
const gameEl = document.getElementById('game');
const renderer = new THREE.WebGLRenderer({antialias:true,alpha:false});
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setClearColor(0x0b0d13,1);
gameEl.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x0b0d13, 30, 220);
const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);

// Lights
const hemi = new THREE.HemisphereLight(0xbfd4ff, 0x334466, 0.6);
scene.add(hemi);
const sun = new THREE.DirectionalLight(0xffffff, 0.9);
sun.position.set(50,80,30);
sun.castShadow = false;
scene.add(sun);

// Ground
const groundGeo = new THREE.PlaneGeometry(800,800);
const groundMat = new THREE.MeshPhongMaterial({color:0x222830});
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);

// City layout (simple blocks/roads)
const buildingMat = new THREE.MeshStandardMaterial({color:0x2a3150, metalness:.2, roughness:.8});
const roadMat = new THREE.MeshStandardMaterial({color:0x3b3f4d, metalness:.1, roughness:.9});
const rnd = (a,b)=>a+Math.random()*(b-a);

// Roads grid
for(let i=-3;i<=3;i++){
  const road = new THREE.Mesh(new THREE.BoxGeometry(800,0.2,20), roadMat);
  road.position.set(0,0.01,i*60);
  scene.add(road);
  const road2 = new THREE.Mesh(new THREE.BoxGeometry(20,0.2,800), roadMat);
  road2.position.set(i*60,0.01,0);
  scene.add(road2);
}
// Buildings around
for(let x=-5;x<=5;x++){
  for(let z=-5;z<=5;z++){
    if((Math.abs(x)<=1 && Math.abs(z)<=1) || Math.random()<0.4) continue;
    const h = rnd(6,22);
    const b = new THREE.Mesh(new THREE.BoxGeometry(rnd(8,14),h,rnd(8,14)), buildingMat);
    b.position.set(x*30 + rnd(-6,6), h/2, z*30 + rnd(-6,6));
    scene.add(b);
  }
}

// Player (capsule-ish + gun box)
const player = {
  obj: new THREE.Object3D(),
  body: new THREE.Mesh(new THREE.CapsuleGeometry(0.6,1.2,4,8), new THREE.MeshStandardMaterial({color:0xffd56a})),
  gun: new THREE.Mesh(new THREE.BoxGeometry(0.6,0.25,1.2), new THREE.MeshStandardMaterial({color:0x30363d})),
  pos:new THREE.Vector3(0,1.2,0), velY:0, onGround:true, yaw:0, pitch:0,
};
player.body.position.set(0,1.2,0);
player.obj.add(player.body);
player.gun.position.set(0.5,1.1,0.2);
player.obj.add(player.gun);
scene.add(player.obj);

// Camera follow (third-person boom)
const cam = {dist:5.5, height:2.2, yawOffset:0};
function updateCamera(){
  const yaw = player.yaw;
  const behind = new THREE.Vector3(Math.sin(yaw), 0, Math.cos(yaw)).multiplyScalar(cam.dist);
  const camPos = new THREE.Vector3().copy(player.pos)
      .add(new THREE.Vector3(0,cam.height,0))
      .sub(behind);
  camera.position.copy(camPos);
  const lookAt = new THREE.Vector3(player.pos.x, player.pos.y+1.2, player.pos.z);
  camera.lookAt(lookAt);
}

// Beacon (mission 1)
const beacon = new THREE.Mesh(new THREE.TorusGeometry(1.2,0.15,12,48), new THREE.MeshStandardMaterial({color:0xffd44d, emissive:0x222000, emissiveIntensity:.6}));
beacon.position.set(18,1.5,-36);
scene.add(beacon);

// Targets (mission 2)
const targetMat = new THREE.MeshStandardMaterial({color:0xff3333, emissive:0x220000, emissiveIntensity:.5});
const targets = [];
function addTarget(x,z){
  const t = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), targetMat.clone());
  t.position.set(x,0.6,z);
  t.userData.isTarget = true;
  scene.add(t); targets.push(t);
}
addTarget(-12,-18); addTarget(24,22); addTarget(-28,35);

// UI binds
const $ = (id)=>document.getElementById(id);
const pointsEl=$('points'), missionEl=$('mission'), msgEl=$('msg');
function setPoints(v){ state.points=v; pointsEl.textContent = v; localStorage.setItem('urbanops_save', JSON.stringify({init:true,points:state.points,sens:state.sens,invY:state.invY})); }
function setMission(t){ state.missionText=t; missionEl.textContent=t; }

// Start menu behaviour
$('sensStart').addEventListener('input', e=>{ state.sens = +e.target.value; $('sensStartVal').textContent=state.sens.toFixed(1); $('sens').value=state.sens; $('sensVal').textContent=state.sens.toFixed(1); saveAndHUD();});
$('invYStart').addEventListener('change', e=>{ state.invY = e.target.checked; $('invY').checked = state.invY; saveAndHUD(); });
$('sens').addEventListener('input', e=>{ state.sens = +e.target.value; $('sensVal').textContent=state.sens.toFixed(1); $('sensStart').value=state.sens; $('sensStartVal').textContent=state.sens.toFixed(1); saveAndHUD();});
$('invY').addEventListener('change', e=>{ state.invY = e.target.checked; saveAndHUD(); });
$('btnSettings').onclick = ()=> $('panel').style.display='block';
$('closePanel').onclick = ()=> $('panel').style.display='none';
$('btnShop').onclick = ()=> alert("Boutique (version courte) : prochain ajout. Actuellement tu peux jouer, gagner des points et finir les missions.");

$('how').onclick = ()=> alert("PC: WASD/ZQSD pour bouger, souris pour cam.\nSouris gauche: FEU, Espace: SAUT, Shift: SPRINT.\nMobile: joystick gauche (bouger), joystick droit (caméra), boutons FEU/SAUT/SPRINT.");

$('play').onclick = async ()=>{
  if(screen.orientation && screen.orientation.lock){ try{ await screen.orientation.lock('landscape'); }catch{} }
  $('menu').style.display='none';
  if(state.mobile){ $('hudMobile').style.display='block'; } else { tryPointerLock(); }
  state.running=true; setMission("1) Rejoindre le beacon ➜ anneau jaune");
  saveAndHUD(); loop(performance.now());
};

// Pointer lock for desktop
function tryPointerLock(){
  renderer.domElement.requestPointerLock = renderer.domElement.requestPointerLock || renderer.domElement.mozRequestPointerLock;
  renderer.domElement.addEventListener('click',()=>{ if(document.pointerLockElement!==renderer.domElement) renderer.domElement.requestPointerLock(); });
  document.addEventListener('pointerlockchange',()=>{},false);
}

// ---------- Controls ----------
window.addEventListener('keydown',e=>{
  if(['KeyW','KeyA','KeyS','KeyD','KeyZ','KeyQ'].includes(e.code)||e.code==='Space'||e.code==='ShiftLeft') e.preventDefault();
  state.keys[e.code]=true;
  if(e.code==='Space') state.jump=true;
  if(e.code==='ShiftLeft') state.sprint=true;
});
window.addEventListener('keyup',e=>{
  state.keys[e.code]=false;
  if(e.code==='ShiftLeft') state.sprint=false;
});
renderer.domElement.addEventListener('mousemove',e=>{
  if(document.pointerLockElement===renderer.domElement && !state.mobile){
    const mult=0.0025*state.sens;
    player.yaw -= e.movementX*mult;
    player.pitch -= (state.invY?-1:1)*e.movementY*mult;
    player.pitch = Math.max(-1.2, Math.min(1.2, player.pitch));
  }
});
renderer.domElement.addEventListener('mousedown',e=>{ if(e.button===0) fire(); });

// Desktop WASD/ZQSD to movement vector
function pollKeys(){
  let x=0,y=0;
  if(state.keys.KeyW || state.keys.KeyZ) y+=1;
  if(state.keys.KeyS) y-=1;
  if(state.keys.KeyA || state.keys.KeyQ) x-=1;
  if(state.keys.KeyD) x+=1;
  state.move.x=x; state.move.y=y;
}

// Mobile sticks
const hudMobile = $('hudMobile');
const stickL=$('stickL'), knobL=$('knobL');
const stickR=$('stickR'), knobR=$('knobR');
const fireBtn=$('btnFire'), jumpBtn=$('btnJump'), sprintBtn=$('btnSprint');

let tL=null,tR=null, centerL=null,centerR=null, valL={x:0,y:0}, valR={x:0,y:0};
function startStick(e,side){
  const t = e.changedTouches[0];
  const id = t.identifier;
  const rect = (side==='L'?stickL:stickR).getBoundingClientRect();
  const center = {x:rect.left+rect.width/2, y:rect.top+rect.height/2};
  const r = rect.width/2 - 24;
  const setVal=(tx,ty)=>{
    const dx = tx-center.x, dy = ty-center.y;
    const len = Math.hypot(dx,dy);
    const nx = (len>r? dx/len*r:dx), ny=(len>r? dy/len*r:dy);
    const knob = (side==='L'?knobL:knobR);
    knob.style.transform = `translate(${nx}px,${ny}px) translate(-50%,-50%)`;
    const vx = nx/r, vy = ny/r;
    if(side==='L'){ valL={x:vx,y:vy}; }
    else { valR={x:vx,y:vy}; }
  };
  const move=(ev)=>{
    for(const tt of ev.changedTouches){
      if(tt.identifier===id) setVal(tt.clientX, tt.clientY);
    }
  };
  const end=(ev)=>{
    for(const tt of ev.changedTouches){
      if(tt.identifier===id){
        (side==='L'?knobL:knobR).style.transform='translate(-50%,-50%)';
        if(side==='L'){ valL={x:0,y:0}; tL=null; centerL=null; }
        else { valR={x:0,y:0}; tR=null; centerR=null; }
        window.removeEventListener('touchmove',move);
        window.removeEventListener('touchend',end);
      }
    }
  };
  window.addEventListener('touchmove',move,{passive:false});
  window.addEventListener('touchend',end,{passive:false});
  (side==='L'?tL=t.id:tR=t.id);
  (side==='L'?centerL=center:centerR=center);
  setVal(t.clientX,t.clientY);
}
stickL.addEventListener('touchstart',e=>{ e.preventDefault(); startStick(e,'L');},{passive:false});
stickR.addEventListener('touchstart',e=>{ e.preventDefault(); startStick(e,'R');},{passive:false});
fireBtn.addEventListener('touchstart',e=>{ e.preventDefault(); fire(); },{passive:false});
jumpBtn.addEventListener('touchstart',e=>{ e.preventDefault(); state.jump=true; },{passive:false});
sprintBtn.addEventListener('touchstart',e=>{ e.preventDefault(); state.sprint=true; },{passive:false});
sprintBtn.addEventListener('touchend',e=>{ e.preventDefault(); state.sprint=false; },{passive:false});

// ---------- Gameplay ----------
function saveAndHUD(){
  localStorage.setItem('urbanops_save', JSON.stringify({init:true,points:state.points,sens:state.sens,invY:state.invY}));
  pointsEl.textContent = state.points; $('pStart').textContent = state.points;
}
function reward(t){ setPoints(state.points + t); }

function fire(){
  if(!state.running) return;
  // Ray from camera forward
  const ray = new THREE.Raycaster();
  ray.setFromCamera(new THREE.Vector2(0,0), camera);
  const intersects = ray.intersectObjects(targets, false);
  if(intersects.length){
    const t = intersects[0].object;
    t.visible=false;
    // remove from list so it cannot be hit again
    const idx = targets.indexOf(t); if(idx>=0) targets.splice(idx,1);
    state.mission2Hits++;
    reward(25);
    setMission(`2) Détruis 3 cibles — ${state.mission2Hits}/3`);
    if(state.mission2Hits>=3){
      reward(300); msg("Mission 2 réussie +300 pts");
      setMission("Toutes missions terminées ✓");
    }
  }
}

function msg(text, ms=2200){
  msgEl.textContent=text; msgEl.style.opacity='1';
  clearTimeout(msg._t); msg._t=setTimeout(()=>{msgEl.style.opacity='.25'}, ms);
}

// Movement update
function updatePlayer(dt){
  // Input vectors
  pollKeys();
  const speed = (state.sprint? 8.5:5.0);
  // desktop keys
  let mvx = state.move.x, mvy = state.move.y;
  // mobile left stick overrides
  if(state.mobile){ mvx = valL.x; mvy = -valL.y; } // up on stick = -y, invert
  const len = Math.hypot(mvx,mvy); if(len>1){ mvx/=len; mvy/=len; }

  // Rotate from right stick (mobile) or pointer (desktop handled in mousemove)
  if(state.mobile){
    const m = 2.3 * state.sens;
    player.yaw -= valR.x * dt * m;
    player.pitch -= (state.invY?-1:1)*(-valR.y) * dt * m;
    player.pitch = Math.max(-1.2, Math.min(1.2, player.pitch));
  }

  // Direction from yaw
  const forward = new THREE.Vector3(Math.sin(player.yaw),0,Math.cos(player.yaw));
  const right = new THREE.Vector3(forward.z,0,-forward.x);
  const moveVec = new THREE.Vector3().addScaledVector(forward, mvy).addScaledVector(right, mvx).multiplyScalar(speed*dt);
  player.pos.add(moveVec);

  // Jump/gravity (simple)
  if(state.jump && player.onGround){ player.velY = 7.8; player.onGround=false; state.jump=false; }
  player.velY += -20*dt;
  player.pos.y += player.velY*dt;
  if(player.pos.y < 1.2){ player.pos.y = 1.2; player.velY=0; player.onGround=true; }
  player.body.position.copy(player.pos);
  player.gun.position.set(player.pos.x+0.5, player.pos.y-0.1, player.pos.z+0.2);

  // Camera
  updateCamera();

  // Time rewards
  state.timeAcc += dt;
  if(state.timeAcc >= 0.5){ state.timeAcc-=0.5; reward(1); }

  // Mission 1: reach beacon
  if(!state.mission1Done){
    const d = player.pos.distanceTo(beacon.position);
    if(d<2){
      state.mission1Done=true;
      reward(150);
      setMission("2) Détruis 3 cibles rouges (25 pts chacune, +300 bonus)");
      msg("Mission 1 réussie +150 pts");
      beacon.visible=false;
    }
  }
}

function render(t){
  renderer.render(scene,camera);
}

// ---------- Loop ----------
let last=0;
function loop(now){
  if(!state.running) return;
  const dt = Math.min(0.033,(now-last)/1000||0.016);
  last = now;

  updatePlayer(dt);
  render(now);
  requestAnimationFrame(loop);
}

// ---------- Resize ----------
function onResize(){
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
}
window.addEventListener('resize', onResize);

// ---------- Init camera & HUD text ----------
player.yaw = 0; player.pitch = 0; player.pos.set(0,1.2,6); updateCamera();
setPoints(state.points); setMission("—");

})();
</script>
</body>
</html>
